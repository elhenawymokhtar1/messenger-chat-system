<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥ØµÙ„Ø§Ø­ localStorage Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .button.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .button.info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .output {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        .status.warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #FFC107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ localStorage Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h1>
        
        <div class="section">
            <h3>ğŸ“Š ÙØ­Øµ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <button class="button info" onclick="checkCurrentState()">ÙØ­Øµ localStorage</button>
            <button class="button info" onclick="testAPI()">Ø§Ø®ØªØ¨Ø§Ø± API</button>
            <div id="currentState" class="output"></div>
        </div>

        <div class="section">
            <h3>ğŸ¢ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h3>
            <button class="button" onclick="setCompanyData()">Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
            <button class="button danger" onclick="clearCompanyData()">Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
            <div id="companyStatus" class="output"></div>
        </div>

        <div class="section">
            <h3>ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</h3>
            <button class="button" onclick="reloadConversations()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</button>
            <button class="button" onclick="openConversationsPage()">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</button>
            <div id="reloadStatus" class="output"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3002';
        const TEST_COMPANY_ID = 'c677b32f-fe1c-4c64-8362-a1c03406608d';

        // ÙØ­Øµ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
        function checkCurrentState() {
            const output = document.getElementById('currentState');
            let result = 'ğŸ” ÙØ­Øµ localStorage:\n\n';
            
            // ÙØ­Øµ localStorage
            const company = localStorage.getItem('company');
            if (company) {
                try {
                    const companyData = JSON.parse(company);
                    result += 'âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù…ÙˆØ¬ÙˆØ¯Ø©:\n';
                    result += `   ğŸ¢ Ø§Ù„Ø§Ø³Ù…: ${companyData.name}\n`;
                    result += `   ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${companyData.email}\n`;
                    result += `   ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: ${companyData.id}\n\n`;
                } catch (e) {
                    result += 'âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ØªØ§Ù„ÙØ© ÙÙŠ localStorage\n\n';
                }
            } else {
                result += 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø±ÙƒØ© ÙÙŠ localStorage\n\n';
            }

            // ÙØ­Øµ sessionStorage
            const sessionData = sessionStorage.getItem('company');
            if (sessionData) {
                result += 'ğŸ“ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ sessionStorage Ø£ÙŠØ¶Ø§Ù‹\n\n';
            }

            // ÙØ­Øµ cookies
            if (document.cookie) {
                result += 'ğŸª Cookies Ù…ÙˆØ¬ÙˆØ¯Ø©:\n';
                result += document.cookie + '\n\n';
            }

            output.textContent = result;
        }

        // Ø§Ø®ØªØ¨Ø§Ø± API
        async function testAPI() {
            const output = document.getElementById('currentState');
            output.textContent = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± API...\n';

            try {
                // Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
                const healthResponse = await fetch(`${API_BASE_URL}/api/health`);
                const healthData = await healthResponse.json();
                
                let result = 'ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± API:\n\n';
                result += `âœ… ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: ${healthData.database?.connected ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}\n`;
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
                const conversationsResponse = await fetch(`${API_BASE_URL}/api/conversations?company_id=${TEST_COMPANY_ID}&limit=5`);
                const conversationsData = await conversationsResponse.json();
                
                result += `ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª: ${conversationsData.length} Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©\n`;
                
                if (conversationsData.length > 0) {
                    result += '   ğŸ“‹ Ø£ÙˆÙ„ Ù…Ø­Ø§Ø¯Ø«Ø©:\n';
                    result += `      ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${conversationsData[0].user_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                    result += `      ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${conversationsData[0].last_message_at || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                }
                
                output.textContent = result;
                
            } catch (error) {
                output.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± API: ${error.message}`;
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
        function setCompanyData() {
            const companyData = {
                id: TEST_COMPANY_ID,
                name: 'Ø´Ø±ÙƒØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
                email: 'test@example.com',
                status: 'active',
                created_at: new Date().toISOString()
            };

            localStorage.setItem('company', JSON.stringify(companyData));
            sessionStorage.setItem('company', JSON.stringify(companyData));

            const output = document.getElementById('companyStatus');
            output.textContent = 'âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ localStorage Ùˆ sessionStorage';
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            const status = document.createElement('div');
            status.className = 'status success';
            status.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!';
            output.appendChild(status);
        }

        // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
        function clearCompanyData() {
            localStorage.removeItem('company');
            sessionStorage.removeItem('company');
            
            // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('company') || key.includes('conversation') || key.includes('message'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));

            const output = document.getElementById('companyStatus');
            output.textContent = 'ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† localStorage';
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
            const status = document.createElement('div');
            status.className = 'status warning';
            status.textContent = 'âš ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©!';
            output.appendChild(status);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        async function reloadConversations() {
            const output = document.getElementById('reloadStatus');
            output.textContent = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...\n';

            try {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
                const company = localStorage.getItem('company');
                if (!company) {
                    output.textContent = 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø±ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.';
                    return;
                }

                const companyData = JSON.parse(company);
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
                const response = await fetch(`${API_BASE_URL}/api/conversations?company_id=${companyData.id}&limit=10`);
                const conversations = await response.json();

                let result = `âœ… ØªÙ… Ø¬Ù„Ø¨ ${conversations.length} Ù…Ø­Ø§Ø¯Ø«Ø©:\n\n`;
                
                conversations.forEach((conv, index) => {
                    result += `${index + 1}. ${conv.user_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                    result += `   ğŸ“… ${conv.last_message_at || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
                    result += `   ğŸ’¬ ${conv.last_message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„'}\n\n`;
                });

                output.textContent = result;

                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                const status = document.createElement('div');
                status.className = 'status success';
                status.textContent = `âœ… ØªÙ… Ø¬Ù„Ø¨ ${conversations.length} Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­!`;
                output.appendChild(status);

            } catch (error) {
                output.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª: ${error.message}`;
                
                const status = document.createElement('div');
                status.className = 'status error';
                status.textContent = 'âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª!';
                output.appendChild(status);
            }
        }

        // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        function openConversationsPage() {
            const output = document.getElementById('reloadStatus');
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
            const company = localStorage.getItem('company');
            if (!company) {
                output.textContent = 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø±ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.';
                return;
            }

            // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
            window.open('http://localhost:8080/conversations', '_blank');
            
            output.textContent = 'ğŸŒ ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯';
            
            const status = document.createElement('div');
            status.className = 'status success';
            status.textContent = 'âœ… ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª!';
            output.appendChild(status);
        }

        // ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            checkCurrentState();
        };
    </script>
</body>
</html>
