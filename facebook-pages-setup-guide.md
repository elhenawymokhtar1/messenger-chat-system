# 📘 دليل ربط صفحات Facebook بالتطبيق

## 🚨 **المشكلة الحالية:**
- الشركة التجريبية `test@company.com` لديها صفحات في قاعدة البيانات
- لكن هذه الصفحات غير مربوطة بالتطبيق في Facebook Developer Console
- النتيجة: التطبيق لا يستطيع الوصول للصفحات أو استقبال الرسائل

---

## 🔧 **الحل خطوة بخطوة:**

### **الخطوة 1: الذهاب إلى Facebook Developer Console**
1. اذهب إلى: https://developers.facebook.com/
2. سجل الدخول بحسابك
3. اختر التطبيق الخاص بك

### **الخطوة 2: إضافة منتج Messenger**
1. في لوحة التحكم، اذهب إلى **"Add Product"**
2. ابحث عن **"Messenger"** واضغط **"Set Up"**
3. ستظهر إعدادات Messenger في القائمة الجانبية

### **الخطوة 3: ربط الصفحات**
1. اذهب إلى **Messenger > Settings**
2. في قسم **"Access Tokens"**:
   - اضغط **"Add or Remove Pages"**
   - ستظهر قائمة بالصفحات التي تديرها
   - اختر الصفحات التي تريد ربطها:
     - **سولا 132** (معرف: 250528358137901)
     - أي صفحات أخرى تريد ربطها

### **الخطوة 4: الحصول على Page Access Tokens**
1. بعد ربط الصفحات، ستظهر في قائمة **"Access Tokens"**
2. لكل صفحة، اضغط **"Generate Token"**
3. **انسخ الـ Token واحفظه** - ستحتاجه لاحقاً

### **الخطوة 5: إعداد Webhooks**
1. اذهب إلى **Messenger > Settings**
2. في قسم **"Webhooks"**:
   - **Callback URL**: `http://localhost:3002/api/webhook/facebook`
   - **Verify Token**: `facebook_verify_token_123`
   - اضغط **"Verify and Save"**

3. في **"Webhook Fields"**، فعّل:
   - ✅ `messages`
   - ✅ `messaging_postbacks`
   - ✅ `messaging_optins`
   - ✅ `message_deliveries`
   - ✅ `message_reads`

### **الخطوة 6: ربط الصفحات بالـ Webhook**
1. في قسم **"Webhooks"**
2. لكل صفحة مربوطة، اضغط **"Subscribe"**
3. تأكد من ظهور ✅ بجانب كل صفحة

---

## 🔄 **تحديث قاعدة البيانات:**

بعد الحصول على الـ Tokens الجديدة، قم بتحديث قاعدة البيانات:

```sql
-- تحديث الـ Token للصفحة الأولى
UPDATE facebook_settings 
SET access_token = 'NEW_PAGE_ACCESS_TOKEN_HERE'
WHERE page_id = '123456789';

-- تحديث الـ Token للصفحة الثانية  
UPDATE facebook_settings 
SET access_token = 'NEW_PAGE_ACCESS_TOKEN_HERE'
WHERE page_id = '250528358137901';
```

---

## 🧪 **اختبار الإعداد:**

### **1. اختبار الـ Webhook:**
```bash
# في Facebook Developer Console
# اذهب إلى Messenger > Settings > Webhooks
# اضغط "Test" بجانب الـ Webhook
```

### **2. اختبار الرسائل:**
1. اذهب إلى إحدى الصفحات المربوطة
2. أرسل رسالة للصفحة من حساب شخصي
3. راقب logs السرفر للتأكد من وصول الرسالة

### **3. فحص الاتصال:**
```bash
# تشغيل سكريبت الفحص
node check-webhook-status.cjs
```

---

## ⚠️ **ملاحظات مهمة:**

### **1. صلاحيات الصفحات:**
- يجب أن تكون **Admin** أو **Editor** للصفحة
- إذا لم تكن تملك الصفحة، اطلب من المالك إضافتك كـ Admin

### **2. حالة التطبيق:**
- إذا كان التطبيق في وضع **Development**، فقط المطورين يمكنهم استخدامه
- للاستخدام العام، يجب تقديم التطبيق للمراجعة

### **3. الـ Tokens:**
- **Page Access Tokens** لها مدة صلاحية
- **User Access Tokens** تنتهي صلاحيتها بسرعة
- استخدم **Long-lived Page Access Tokens** للإنتاج

### **4. الـ Webhook URL:**
- `http://localhost:3002` يعمل فقط محلياً
- للإنتاج، استخدم **ngrok** أو خادم عام
- مثال: `https://your-domain.com/api/webhook/facebook`

---

## 🚀 **الخطوات التالية:**

1. **✅ اتبع الخطوات أعلاه لربط الصفحات**
2. **🔄 حدّث الـ Tokens في قاعدة البيانات**
3. **🧪 اختبر الـ Webhook**
4. **📱 أرسل رسالة تجريبية**
5. **📊 راقب النتائج في السرفر**

---

## 🆘 **إذا واجهت مشاكل:**

### **خطأ في التحقق من الـ Webhook:**
- تأكد من تشغيل السرفر على المنفذ 3002
- تأكد من صحة الـ Verify Token
- تحقق من logs السرفر

### **لا تظهر الصفحات:**
- تأكد من صلاحياتك على الصفحة
- تحقق من إعدادات الخصوصية للصفحة
- تأكد من أن الصفحة منشورة وليست مخفية

### **الـ Tokens لا تعمل:**
- تأكد من نسخ الـ Token كاملاً
- تحقق من انتهاء صلاحية الـ Token
- جرب إنشاء Token جديد

---

## 📞 **للمساعدة:**
إذا احتجت مساعدة في أي خطوة، أخبرني وسأساعدك خطوة بخطوة!
