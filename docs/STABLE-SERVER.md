# 🛡️ الخادم المستقر - دليل الاستخدام

## 📋 نظرة عامة

تم تطوير نظام خادم مستقر يمنع انقطاع الخدمة ويعيد تشغيل الخادم تلقائياً عند حدوث أي مشاكل.

## 🚀 كيفية التشغيل

### 1. التشغيل العادي
```bash
npm run dev:api
```

### 2. التشغيل المستقر (موصى به)
```bash
npm run api:stable
```

### 3. التشغيل الكامل مع الواجهة
```bash
npm run start:stable
```

## 🔍 المميزات

### ✅ معالجة الأخطاء المتقدمة
- معالجة الأخطاء غير المعالجة (Uncaught Exceptions)
- معالجة الرفض غير المعالج (Unhandled Rejections)
- معالجة أخطاء Express
- معالجة الطلبات غير الموجودة (404)

### 📊 مراقبة الأداء
- مراقبة استهلاك الذاكرة كل 30 ثانية
- تنبيهات عند استهلاك ذاكرة عالي
- تنظيف الذاكرة التلقائي
- مراقبة وقت التشغيل

### 🔄 إعادة التشغيل التلقائي
- إعادة تشغيل تلقائي عند توقف الخادم
- حد أقصى 10 محاولات إعادة تشغيل
- تأخير 5 ثوان بين المحاولات
- إعادة تعيين العداد كل ساعة

### 🛡️ الأمان المحسن
- CORS محدود للمضيفين المسموحين
- معالجة آمنة للإغلاق
- تسجيل مفصل للأخطاء

## 📡 نقاط النهاية المتاحة

### 🔍 فحص صحة الخادم
```
GET /api/health
```

**الاستجابة:**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-01T12:00:00.000Z",
    "uptime": "15 دقيقة",
    "memory": {
      "used": "150MB",
      "heap": "80MB",
      "healthy": true
    },
    "database": {
      "connected": true,
      "status": "متصل"
    },
    "server": {
      "port": 3002,
      "environment": "development"
    }
  }
}
```

### 📊 نقاط النهاية الأخرى
- `GET /api/conversations` - قائمة المحادثات
- `GET /api/messages/recent` - الرسائل الحديثة
- `POST /api/send-message` - إرسال رسالة
- `GET /api/companies/{id}/store` - إدارة المتجر

## ⚙️ الإعدادات

### 📁 ملف الإعدادات
`src/config/server-config.ts`

### 🔧 الإعدادات المتاحة

#### المراقبة
```typescript
MONITORING: {
  ENABLED: true,
  INTERVAL_MS: 30000, // 30 ثانية
  MEMORY_WARNING_MB: 300,
  MEMORY_CRITICAL_MB: 500
}
```

#### إعادة التشغيل
```typescript
RESTART: {
  MAX_ATTEMPTS: 10,
  DELAY_MS: 5000,
  RESET_INTERVAL_MS: 3600000 // ساعة
}
```

#### الأمان
```typescript
SECURITY: {
  CORS: {
    ORIGIN: ['http://localhost:8082', 'http://192.168.1.3:8082'],
    CREDENTIALS: true
  }
}
```

## 🐛 استكشاف الأخطاء

### 1. الخادم لا يبدأ
```bash
# تحقق من المنفذ
netstat -an | findstr :3002

# تحقق من الإعدادات
npm run dev:api
```

### 2. انقطاع متكرر
```bash
# استخدم الخادم المستقر
npm run api:stable

# تحقق من السجلات
# ابحث عن رسائل [MONITOR] في الكونسول
```

### 3. مشاكل الذاكرة
```bash
# تشغيل مع تنظيف الذاكرة
node --expose-gc scripts/start-server-stable.js
```

### 4. مشاكل قاعدة البيانات
```bash
# تحقق من الاتصال
curl http://localhost:3002/api/health
```

## 📈 مراقبة الأداء

### 🔍 السجلات المهمة
- `✅ [SERVER] الخادم يعمل بشكل مستقر` - الخادم يعمل
- `📊 [MONITOR] تقرير صحة الخادم` - تقرير الأداء
- `⚠️ [MONITOR] استهلاك ذاكرة عالي` - تحذير الذاكرة
- `🔄 [MANAGER] إعادة تشغيل الخادم` - إعادة التشغيل

### 📊 مؤشرات الأداء
- **وقت التشغيل**: يجب أن يزيد باستمرار
- **استهلاك الذاكرة**: يجب أن يكون أقل من 500MB
- **حالة قاعدة البيانات**: يجب أن تكون "متصل"
- **عدد إعادة التشغيل**: يجب أن يكون 0 أو قليل

## 🚨 التنبيهات

### ⚠️ تحذيرات الذاكرة
- **300MB+**: تحذير استهلاك عالي
- **500MB+**: استهلاك حرج
- **90%+ Heap**: ذاكرة ممتلئة

### 🔄 إعادة التشغيل
- **5 محاولات**: تحذير
- **10 محاولات**: توقف نهائي
- **كل ساعة**: إعادة تعيين العداد

## 📞 الدعم

عند حدوث مشاكل:
1. تحقق من السجلات في الكونسول
2. استخدم `/api/health` لفحص الحالة
3. جرب إعادة تشغيل الخادم المستقر
4. تحقق من إعدادات قاعدة البيانات
