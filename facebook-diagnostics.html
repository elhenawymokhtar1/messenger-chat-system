<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ Facebook Settings</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 18px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .test-item {
            margin: 10px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
            font-family: monospace;
            font-size: 13px;
        }
        
        .test-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .test-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .test-item.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .json-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .status-indicator.online {
            background: #28a745;
        }
        
        .status-indicator.offline {
            background: #dc3545;
        }
        
        .status-indicator.unknown {
            background: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ Facebook Settings</h1>
        
        <div class="controls">
            <button class="btn" onclick="runFullDiagnostics()">ğŸš€ ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„</button>
            <button class="btn btn-success" onclick="testLocalStorage()">ğŸ’¾ ÙØ­Øµ localStorage</button>
            <button class="btn btn-warning" onclick="testServers()">ğŸ–¥ï¸ ÙØ­Øµ Ø§Ù„Ø®ÙˆØ§Ø¯Ù…</button>
            <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ...</p>
        </div>
        
        <!-- ÙØ­Øµ localStorage -->
        <div class="section">
            <h3>ğŸ’¾ ÙØ­Øµ localStorage</h3>
            <div id="localStorage-results"></div>
        </div>
        
        <!-- ÙØ­Øµ Ø§Ù„Ø®ÙˆØ§Ø¯Ù… -->
        <div class="section">
            <h3>ğŸ–¥ï¸ ÙØ­Øµ Ø§Ù„Ø®ÙˆØ§Ø¯Ù…</h3>
            <div id="servers-results"></div>
        </div>
        
        <!-- ÙØ­Øµ Facebook API -->
        <div class="section">
            <h3>ğŸ“˜ ÙØ­Øµ Facebook API</h3>
            <div id="facebook-api-results"></div>
        </div>
        
        <!-- ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="section">
            <h3>ğŸ—„ï¸ ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div id="database-results"></div>
        </div>
        
        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
        <div class="section">
            <h3>ğŸ› ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ø­Ù„ÙˆÙ„</h3>
            <div id="error-details"></div>
        </div>
        
        <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… -->
        <div class="section">
            <h3>ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù…</h3>
            <div id="raw-data" class="json-display"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002';
        const FRONTEND_BASE = 'http://localhost:8080';
        
        let diagnosticsData = {
            localStorage: {},
            servers: {},
            facebookApi: {},
            database: {},
            errors: [],
            timestamp: new Date().toISOString()
        };

        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function addResult(containerId, message, type = 'info', data = null) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-item ${type}`;
            
            let content = message;
            if (data) {
                content += `<br><small>${JSON.stringify(data, null, 2)}</small>`;
            }
            
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearResults() {
            const containers = ['localStorage-results', 'servers-results', 'facebook-api-results', 'database-results', 'error-details'];
            containers.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        async function testLocalStorage() {
            clearResults();
            addResult('localStorage-results', 'ğŸ” ÙØ­Øµ localStorage...', 'info');
            
            const keys = ['auth_token', 'company_id', 'company', 'userToken'];
            const localStorageData = {};
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                localStorageData[key] = value;
                
                if (value) {
                    if (key === 'company') {
                        try {
                            const parsed = JSON.parse(value);
                            addResult('localStorage-results', `âœ… ${key}: Ù…ÙˆØ¬ÙˆØ¯ ÙˆØµØ­ÙŠØ­`, 'success', {
                                id: parsed.id,
                                name: parsed.name,
                                email: parsed.email
                            });
                        } catch (e) {
                            addResult('localStorage-results', `âŒ ${key}: Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† ØªØ§Ù„Ù`, 'error', value.substring(0, 100));
                        }
                    } else {
                        addResult('localStorage-results', `âœ… ${key}: ${value}`, 'success');
                    }
                } else {
                    addResult('localStorage-results', `âŒ ${key}: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`, 'error');
                }
            });
            
            diagnosticsData.localStorage = localStorageData;
            updateRawData();
        }

        async function testServers() {
            addResult('servers-results', 'ğŸ” ÙØ­Øµ Ø§Ù„Ø®ÙˆØ§Ø¯Ù…...', 'info');
            
            // ÙØ­Øµ Ø®Ø§Ø¯Ù… API (3002)
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    addResult('servers-results', 'âœ… Ø®Ø§Ø¯Ù… API (3002): ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success', data);
                    diagnosticsData.servers.api = { status: 'online', data };
                } else {
                    addResult('servers-results', `âŒ Ø®Ø§Ø¯Ù… API (3002): Ø®Ø·Ø£ ${response.status}`, 'error');
                    diagnosticsData.servers.api = { status: 'error', code: response.status };
                }
            } catch (error) {
                addResult('servers-results', `âŒ Ø®Ø§Ø¯Ù… API (3002): ØºÙŠØ± Ù…ØªØ§Ø­`, 'error', error.message);
                diagnosticsData.servers.api = { status: 'offline', error: error.message };
            }
            
            // ÙØ­Øµ Ø®Ø§Ø¯Ù… Frontend (8080)
            try {
                const response = await fetch(`${FRONTEND_BASE}/`);
                if (response.ok) {
                    addResult('servers-results', 'âœ… Ø®Ø§Ø¯Ù… Frontend (8080): ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
                    diagnosticsData.servers.frontend = { status: 'online' };
                } else {
                    addResult('servers-results', `âš ï¸ Ø®Ø§Ø¯Ù… Frontend (8080): Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©`, 'warning');
                    diagnosticsData.servers.frontend = { status: 'warning', code: response.status };
                }
            } catch (error) {
                addResult('servers-results', `âŒ Ø®Ø§Ø¯Ù… Frontend (8080): ØºÙŠØ± Ù…ØªØ§Ø­`, 'error', error.message);
                diagnosticsData.servers.frontend = { status: 'offline', error: error.message };
            }
            
            updateRawData();
        }

        async function testFacebookApi() {
            addResult('facebook-api-results', 'ğŸ” ÙØ­Øµ Facebook API...', 'info');

            const companyId = localStorage.getItem('company_id');
            if (!companyId) {
                addResult('facebook-api-results', 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ company_id ÙÙŠ localStorage', 'error');
                return;
            }

            // ÙØ­Øµ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Facebook
            try {
                const response = await fetch(`${API_BASE}/api/facebook/settings?company_id=${companyId}`);
                const data = await response.json();

                if (response.ok) {
                    addResult('facebook-api-results', `âœ… Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Facebook: Ù†Ø¬Ø­ (${Array.isArray(data) ? data.length : 0} ØµÙØ­Ø©)`, 'success', data);
                    diagnosticsData.facebookApi.settings = { status: 'success', data };
                } else {
                    addResult('facebook-api-results', `âŒ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Facebook: ÙØ´Ù„`, 'error', data);
                    diagnosticsData.facebookApi.settings = { status: 'error', data };
                }
            } catch (error) {
                addResult('facebook-api-results', `âŒ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Facebook: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„`, 'error', error.message);
                diagnosticsData.facebookApi.settings = { status: 'error', error: error.message };
            }

            updateRawData();
        }

        async function testDatabase() {
            addResult('database-results', 'ğŸ” ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');

            // ÙØ­Øµ ØµØ­Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            try {
                const response = await fetch(`${API_BASE}/api/db-test`);
                const data = await response.json();

                if (response.ok && data.success) {
                    addResult('database-results', 'âœ… Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù†Ø¬Ø­', 'success', data);
                    diagnosticsData.database.connection = { status: 'success', data };
                } else {
                    addResult('database-results', 'âŒ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙØ´Ù„', 'error', data);
                    diagnosticsData.database.connection = { status: 'error', data };
                }
            } catch (error) {
                addResult('database-results', 'âŒ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø®Ø·Ø£', 'error', error.message);
                diagnosticsData.database.connection = { status: 'error', error: error.message };
            }

            // ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Facebook ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            try {
                const response = await fetch(`${API_BASE}/api/db-facebook-check`);
                const data = await response.json();

                if (response.ok && data.success) {
                    addResult('database-results', `âœ… Ø¨ÙŠØ§Ù†Ø§Øª Facebook: ${data.total} ØµÙØ­Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©`, 'success', data);
                    diagnosticsData.database.facebookData = { status: 'success', data };
                } else {
                    addResult('database-results', 'âŒ Ø¨ÙŠØ§Ù†Ø§Øª Facebook: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨', 'error', data);
                    diagnosticsData.database.facebookData = { status: 'error', data };
                }
            } catch (error) {
                addResult('database-results', 'âŒ Ø¨ÙŠØ§Ù†Ø§Øª Facebook: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error', error.message);
                diagnosticsData.database.facebookData = { status: 'error', error: error.message };
            }

            updateRawData();
        }

        async function analyzeErrors() {
            addResult('error-details', 'ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡...', 'info');

            const errors = [];
            const solutions = [];

            // ØªØ­Ù„ÙŠÙ„ localStorage
            const companyId = localStorage.getItem('company_id');
            const authToken = localStorage.getItem('auth_token');
            const company = localStorage.getItem('company');

            if (!companyId) {
                errors.push('âŒ company_id ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ localStorage');
                solutions.push('âœ… Ø§Ù„Ø­Ù„: ØªØ¹ÙŠÙŠÙ† company_id = c677b32f-fe1c-4c64-8362-a1c03406608d');
            }

            if (!authToken) {
                errors.push('âŒ auth_token ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ localStorage');
                solutions.push('âœ… Ø§Ù„Ø­Ù„: ØªØ¹ÙŠÙŠÙ† auth_token = test-token-c677b32f-fe1c-4c64-8362-a1c03406608d');
            }

            if (!company) {
                errors.push('âŒ company ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ localStorage');
                solutions.push('âœ… Ø§Ù„Ø­Ù„: ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ localStorage');
            } else {
                try {
                    const parsed = JSON.parse(company);
                    if (!parsed.id || parsed.id !== companyId) {
                        errors.push('âŒ company.id Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ company_id');
                        solutions.push('âœ… Ø§Ù„Ø­Ù„: ØªØµØ­ÙŠØ­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©');
                    }
                } catch (e) {
                    errors.push('âŒ Ø¨ÙŠØ§Ù†Ø§Øª company ØªØ§Ù„ÙØ© ÙÙŠ localStorage');
                    solutions.push('âœ… Ø§Ù„Ø­Ù„: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©');
                }
            }

            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®ÙˆØ§Ø¯Ù…
            if (diagnosticsData.servers.api?.status !== 'online') {
                errors.push('âŒ Ø®Ø§Ø¯Ù… API (3002) ØºÙŠØ± Ù…ØªØ§Ø­');
                solutions.push('âœ… Ø§Ù„Ø­Ù„: ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… API Ø¨Ø§Ù„Ø£Ù…Ø±: node database-connected-server.cjs');
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (errors.length === 0) {
                addResult('error-details', 'ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
            } else {
                errors.forEach(error => addResult('error-details', error, 'error'));
                solutions.forEach(solution => addResult('error-details', solution, 'warning'));
            }

            diagnosticsData.errors = errors;
            diagnosticsData.solutions = solutions;
            updateRawData();
        }

        function clearAllData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                const keys = ['auth_token', 'company_id', 'company', 'userToken'];
                keys.forEach(key => localStorage.removeItem(key));

                addResult('error-details', 'ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage', 'warning');
                testLocalStorage();
            }
        }

        function updateRawData() {
            document.getElementById('raw-data').textContent = JSON.stringify(diagnosticsData, null, 2);
        }

        async function runFullDiagnostics() {
            clearResults();
            showLoading(true);

            try {
                await testLocalStorage();
                await testServers();
                await testFacebookApi();
                await testDatabase();
                await analyzeErrors();
            } catch (error) {
                addResult('error-details', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            updateRawData();
            testLocalStorage();
        };
    </script>
</body>
</html>
