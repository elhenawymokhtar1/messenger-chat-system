import React, { useState, useRef } from 'react';
import { toast } from 'sonner';
import { useCurrentCompany } from '../hooks/useCurrentCompany';
import { messagesApi } from '../lib/mysql-api';

interface TestLog {
  timestamp: string;
  level: 'info' | 'success' | 'warning' | 'error';
  message: string;
  data?: any;
}

const ImageTestPage: React.FC = () => {
  const { company } = useCurrentCompany();
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  // ุจูุงูุงุช ุงููุญุงุฏุซุฉ ุงููุญุฏุฏุฉ - Mokhtar Elenawy
  const TEST_CONVERSATION_ID = '0a6962e4-a5d6-4663-ab0e-25f7ffa175db';
  const TEST_CUSTOMER_NAME = 'Mokhtar Elenawy';
  
  const [selectedImage, setSelectedImage] = useState<File | null>(null);
  const [imagePreview, setImagePreview] = useState<string | null>(null);
  const [messageText, setMessageText] = useState('๐งช ุงุฎุชุจุงุฑ ุฑูุน ุตูุฑุฉ ูู ุตูุญุฉ ุงูุชุดุฎูุต');
  const [isUploading, setIsUploading] = useState(false);
  const [testLogs, setTestLogs] = useState<TestLog[]>([]);
  const [lastResponse, setLastResponse] = useState<any>(null);

  // ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ
  const addLog = (level: TestLog['level'], message: string, data?: any) => {
    const newLog: TestLog = {
      timestamp: new Date().toLocaleTimeString('ar-EG'),
      level,
      message,
      data
    };
    setTestLogs(prev => [...prev, newLog]);
    console.log(`[${level.toUpperCase()}] ${message}`, data || '');

    // ุฅุธูุงุฑ toast ููุฃุฎุทุงุก ูุงููุฌุงุญ
    if (level === 'error') {
      toast.error(message);
    } else if (level === 'success') {
      toast.success(message);
    }
  };

  // ูุณุญ ุงูุณุฌูุงุช
  const clearLogs = () => {
    setTestLogs([]);
    setLastResponse(null);
  };

  // ุงุฎุชูุงุฑ ุตูุฑุฉ
  const handleImageSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    addLog('info', 'ุชู ุงุฎุชูุงุฑ ุตูุฑุฉ', {
      name: file.name,
      size: file.size,
      type: file.type
    });

    setSelectedImage(file);

    // ุฅูุดุงุก ูุนุงููุฉ ููุตูุฑุฉ
    const reader = new FileReader();
    reader.onload = (e) => {
      const result = e.target?.result as string;
      setImagePreview(result);
      addLog('success', 'ุชู ุฅูุดุงุก ูุนุงููุฉ ุงูุตูุฑุฉ');
    };
    reader.onerror = () => {
      addLog('error', 'ูุดู ูู ูุฑุงุกุฉ ุงูุตูุฑุฉ');
    };
    reader.readAsDataURL(file);
  };

  // ุฅุฑุณุงู ุงูุตูุฑุฉ
  const handleSendImage = async () => {
    if (!selectedImage || !company) {
      addLog('error', 'ูุง ุชูุฌุฏ ุตูุฑุฉ ูุฎุชุงุฑุฉ ุฃู ุจูุงูุงุช ุงูุดุฑูุฉ');
      return;
    }

    setIsUploading(true);
    addLog('info', 'ุจุฏุก ุนูููุฉ ุฑูุน ุงูุตูุฑุฉ...');

    try {
      // ุชุญููู ุงูุตูุฑุฉ ุฅูู base64
      addLog('info', 'ุชุญููู ุงูุตูุฑุฉ ุฅูู base64...');
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const base64Data = e.target?.result as string;
          addLog('success', 'ุชู ุชุญููู ุงูุตูุฑุฉ ุฅูู base64', {
            size: base64Data.length,
            preview: base64Data.substring(0, 100) + '...'
          });

          // ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุฅุฑุณุงู
          const messageData = {
            conversation_id: TEST_CONVERSATION_ID,
            company_id: company.id,
            message_text: messageText || '๐ท ุตูุฑุฉ',
            message_type: 'image',
            image_data: base64Data,
            image_name: selectedImage.name
          };

          addLog('info', 'ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู API...', {
            conversation_id: messageData.conversation_id,
            company_id: messageData.company_id,
            message_text: messageData.message_text,
            message_type: messageData.message_type,
            image_name: messageData.image_name,
            image_data_size: base64Data.length
          });

          // ุฅุฑุณุงู ุงูุฑุณุงูุฉ
          const response = await messagesApi.sendMessage(messageData);
          
          addLog('success', 'ุชู ุฅุฑุณุงู ุงูุตูุฑุฉ ุจูุฌุงุญ!', response);
          setLastResponse(response);
          toast.success('ุชู ุฅุฑุณุงู ุงูุตูุฑุฉ ุจูุฌุงุญ!');

          // ูุณุญ ุงููููุฐุฌ
          setSelectedImage(null);
          setImagePreview(null);
          setMessageText('๐งช ุงุฎุชุจุงุฑ ุฑูุน ุตูุฑุฉ ูู ุตูุญุฉ ุงูุชุดุฎูุต');
          if (fileInputRef.current) {
            fileInputRef.current.value = '';
          }

        } catch (error: any) {
          addLog('error', 'ูุดู ูู ุฅุฑุณุงู ุงูุตูุฑุฉ', {
            error: error.message,
            stack: error.stack
          });
          toast.error('ูุดู ูู ุฅุฑุณุงู ุงูุตูุฑุฉ: ' + error.message);
        } finally {
          setIsUploading(false);
        }
      };

      reader.onerror = () => {
        addLog('error', 'ูุดู ูู ูุฑุงุกุฉ ุงูุตูุฑุฉ');
        setIsUploading(false);
      };

      reader.readAsDataURL(selectedImage);

    } catch (error: any) {
      addLog('error', 'ุฎุทุฃ ุนุงู ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ', {
        error: error.message,
        stack: error.stack
      });
      toast.error('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ');
      setIsUploading(false);
    }
  };

  // ุชูุณูู ุนุฑุถ ุงูุจูุงูุงุช
  const formatData = (data: any) => {
    if (!data) return '';
    return JSON.stringify(data, null, 2);
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-4xl mx-auto">
        {/* ุงูุนููุงู */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">
            ๐งช ุตูุญุฉ ุงุฎุชุจุงุฑ ุฑูุน ุงูุตูุฑ
          </h1>
          <p className="text-gray-600">
            ุงุฎุชุจุงุฑ ุฑูุน ุงูุตูุฑ ูุน ุงููุญุงุฏุซุฉ: <strong>{TEST_CUSTOMER_NAME}</strong>
          </p>
          <p className="text-sm text-gray-500 mt-1">
            ูุนุฑู ุงููุญุงุฏุซุฉ: {TEST_CONVERSATION_ID}
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* ูููุฐุฌ ุฑูุน ุงูุตูุฑุฉ */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              ๐ค ุฑูุน ุตูุฑุฉ
            </h2>

            {/* ุงุฎุชูุงุฑ ุงูุตูุฑุฉ */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ุงุฎุชุฑ ุตูุฑุฉ:
              </label>
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handleImageSelect}
                className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
              />
            </div>

            {/* ูุนุงููุฉ ุงูุตูุฑุฉ */}
            {imagePreview && (
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ูุนุงููุฉ ุงูุตูุฑุฉ:
                </label>
                <img
                  src={imagePreview}
                  alt="ูุนุงููุฉ"
                  className="max-w-full h-48 object-contain border rounded-lg"
                />
              </div>
            )}

            {/* ูุต ุงูุฑุณุงูุฉ */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ูุต ุงูุฑุณุงูุฉ (ุงุฎุชูุงุฑู):
              </label>
              <textarea
                value={messageText}
                onChange={(e) => setMessageText(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows={3}
                placeholder="ุงูุชุจ ูุต ูุน ุงูุตูุฑุฉ..."
              />
            </div>

            {/* ุฃุฒุฑุงุฑ ุงูุชุญูู */}
            <div className="flex gap-3">
              <button
                onClick={handleSendImage}
                disabled={!selectedImage || isUploading}
                className="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
              >
                {isUploading ? '๐ ุฌุงุฑู ุงูุฅุฑุณุงู...' : '๐ค ุฅุฑุณุงู ุงูุตูุฑุฉ'}
              </button>
              
              <button
                onClick={clearLogs}
                className="bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700"
              >
                ๐๏ธ ูุณุญ ุงูุณุฌูุงุช
              </button>
            </div>
          </div>

          {/* ุณุฌูุงุช ุงูุชุดุฎูุต */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              ๐ ุณุฌูุงุช ุงูุชุดุฎูุต
            </h2>
            
            <div className="h-96 overflow-y-auto border rounded-lg p-3 bg-gray-50">
              {testLogs.length === 0 ? (
                <p className="text-gray-500 text-center">ูุง ุชูุฌุฏ ุณุฌูุงุช ุจุนุฏ...</p>
              ) : (
                testLogs.map((log, index) => (
                  <div
                    key={index}
                    className={`mb-2 p-2 rounded text-sm ${
                      log.level === 'error' ? 'bg-red-100 text-red-800' :
                      log.level === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                      log.level === 'success' ? 'bg-green-100 text-green-800' :
                      'bg-blue-100 text-blue-800'
                    }`}
                  >
                    <div className="font-medium">
                      [{log.timestamp}] {log.message}
                    </div>
                    {log.data && (
                      <pre className="mt-1 text-xs overflow-x-auto">
                        {formatData(log.data)}
                      </pre>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>
        </div>

        {/* ุขุฎุฑ ุงุณุชุฌุงุจุฉ */}
        {lastResponse && (
          <div className="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              ๐ ุขุฎุฑ ุงุณุชุฌุงุจุฉ ูู ุงูุฎุงุฏู
            </h2>
            <pre className="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm">
              {formatData(lastResponse)}
            </pre>
          </div>
        )}
      </div>
    </div>
  );
};

export default ImageTestPage;
